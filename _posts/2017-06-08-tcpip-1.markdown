---
layout:     post
title:      "TCP/IP详解学习笔记（1）"
subtitle:   "广播和本地组播"
date:       2017-06-08
author:     "SmartYi"
header-img: "img/in-post/tcp-ip-1/head.jpg"
tags:
    - TCP/IP
    - 计算机网络
---


## TCP/IP详解学习笔记（1）——广播和本地组播

> 2017-06-07 By Mingkuan Li

#### 1. 引言

IP地址可以分为4类：单播（unicast）、任播（anycast）、组播（multicast）和广播（broadcast），其中广播和组播为应用程序提供了两种服务，分别是数据分组交付至多个目的地以及通过客户端请求/发现服务器。

- 交付至多个目的地：有许多应用程序将消息交付至多个收件方，例如多人会议等，如果没有广播或组播，需要把数据的副本交付至每一个目的地，是非常低效的。
- 通过客户端请求服务器：使用广播或组播应用程序可以向一个服务器发送请求，而不用知道任何特定服务器的IP地址，例如DHCP获取初始IP地址的时候，找到附近的DHCP服务器。

对比广播和组播，广播请求会影响广播范围内所有可能到达的主机，而组播只影响那些可能对该请求感兴趣的主机，因此，在广播的更高开销和简单性以及组播的效率改善和更多的复杂性之间存在一种平衡。IPv4支持广播和组播，但IPv6只支持组播。对于IPv4组播中是可选的功能，而IPv6由于邻居发现协议（ND）需要使用，因此是强制性的。一般来说，只有使用UDP传输协议的用户应用程序利用到广播和组播，而TCP是一个面向连接的协议，意味着两个主机和每台主机上的一个进程之间有一个连接。

#### 2. 广播

广播是指将报文发送到网络中所有可能的接受者，原理是路由器简单地将他接收到的任意报文副本转离除报文到达口以外的每个接口。

在Linux下，使用ping程序可以向广播地址发送ICMPv4回显请求的报文：

![向广播地址发送回显请求](/img/in-post/tcp-ip-1/1.png)

#### 3. 组播

为了减少在广播中涉及的开销，可以只向那些对他感兴趣的接收方发送流量，这样的方式被称为组播。实现组播比广播更具有挑战性也更复杂，因为组播状态（multicast state）必须由主机和路由器来保持，已说明哪些接收方对哪类流量有兴趣。在组播TCP/IP模型中，接收方通过指明组播地址和可选源列表来表明他们对希望接收的流量的兴趣。这个信息作为主机和路由器中的软状态（soft state）来维持，意味着必须定时更新或超时删除。当这发生时，组播流量的交付要么停止，要么恢复为广播。

IP组播在如以太网的链路层网络中，起初使用一种基于组寻址工作方式的设计。在这种方法中，每个站点选择愿意接受流量的组地址，而不考虑发送方，因此对于发送方的身份是不敏感的，也被称为任源组播（ASM）。而另外如果对发送方的身份敏感，需要使用特定源组播（SSM），它允许终端站点明确地包含或排除从一组特定发送方发送到一个组播组的流量。

##### 3.1 将IP组播地址转换为MAC地址

为了在链路层网络中有效承载IP组播，在IP层和链路层帧的数据分组和地址之间应该有一个一一对应的映射。IANA（互联网地址编码分配机构，Internet Assigned Numbers Authority）被赋予权限使用以01:00:5e开头的组播MAC地址，通常这个作为以太网地址中高序的24位。

IANA分配一半的组地址块用于识别IEEE 802 LAN上的IPv4组播流量。这意味着，对应到IPv4组播的以太网地址范围为01:00:5e:00:00:00~01:00:5e:ff:ff:ff。IPv4地址到他们对应的MAC地址的映射关系如下图所示：

![IPv4地址到MAC地址的映射关系](/img/in-post/tcp-ip-1/2.png)

对于IPv4，组播地址包含于224.0.0.0~239.255.255.255的D类地址空间中，所有这样的高地址共享一个4位的序列1110，因此有28位可用来编码整个组播地址空间。而链路层地址只有23位，因此映射不是唯一的，每32个不同的IPv4组地址被映射到相同的MAC层组地址上。

对于IPv6，16位的OUI（组织唯一标识符）前缀是33:33，这意味着IPv6地址的最后32位可以用来形成链路层地址。因此任何以相同的32位结束的地址映射到相同的MAC地址。特别的，所有的IPv6组播地址以ff开始，随后8位用户标志和范围信息，因此，IPv6地址到他们对应的MAC地址的映射关系如下图所示：

![IPv6地址到MAC地址的映射关系](/img/in-post/tcp-ip-1/3.png)

##### 3.2 接收和发送组播数据包

组播的基本是在主机给定的接口上进程**加入**或**离开**一个或多个组播的概念，其中进程表示操作系统执行程序的单元。在一个给定接口上的组播组的成员资格是动态的，它随进程加入或离开组而改变。除了加入或离开组，如果进程希望指定它希望收听或排除的源，就需要额外的方法。这些是支持组播的主机上的任意API的必需部分。组的成员资格与接口相关，因此我们使用限定词“接口”。一个进程可以在多个接口上加入同一组，也可以加入同一接口上的多个组，或是其中的任意组合。

##### 3.3 主机地址过滤

在一个典型的交换式以太网环境中，广播和组播帧沿着在交换机之间形成的一棵生成树 在VLAN中的所有段被复制。这样的帧被交付至每台主机上的NIC，它将会检查帧的正确性 (使用CRC)，并且决定是否接收该帧，并将其交付给设备驱动程序和网络协议栈。通常情况下， NIC只接收目的地址是接口的硬件地址或广播地址的那些帧。然而，当涉及组播帧时，情况就更加复杂了。每层实现对报文的过滤如下图所示：

![报文过滤](/img/in-post/tcp-ip-1/4.png)

NIC往往有两类，**一类对组播地址的hash值进行过滤**，主机地址记录一些感兴趣的硬件地址哈希来实现过滤。而由于存在哈希冲突，一些不需要的帧可以通过过滤。**另外一类侦听组播地址的一张有限表**。这意味着如果主机需要接收超过表中能够容纳的更多的组播地址的帧，NIC就会进入一种“组播混杂”模式，这种模式下所有组播流量交给主机软件进行过滤。因此两种类型的接口都需要设备驱动程序或者高层软件进行检查，以确定接收到的帧是否真的需要。另外一个需要高层软件进行进一步检查的原因是组播IPv4地址或IPv6地址映射到48位硬件地址是不唯一的。

一旦NIC硬件验证一个帧是可以接受的，即CRC是正确的，任何VLAN标签匹配，目的MAC地址与一个或多个NIC表中一个地址条目相匹配，该帧被传递到设备驱动器程序，在此执行另外的过滤。首先，帧类型必须指定一种被支持的协议，例如，IPv4、IPv6、ARP等。其次，可以执行另外的组播过滤以检查主机是否属于被寻址的组播组（通过目的IP地址说明）。然后，设备驱动程序将该帧传递到下一层。如果在传输层的UDP发现没有进程在使用该目的端口，那么数据报就被丢弃并生产一个ICMP端口不可达报文。如果存在校验和错误则默默丢弃这个数据报。

**研究组播寻址特征背后的主要动机之一是避免广播的开销**。组播的目的就是减少对该应用没有兴趣的主机的负担。使用组播，一 台主机明确地加人一个或多个组播组。如果可能的话，NIC被告知主机属于哪个组播组，并且只有那些与IP层组播组相关联的组播帧被允许通过NIC中的过滤器。这一机制所提供的就是使主机上的开销更小，作为代价，需要在管理组播地址和组成员中添加额外的复杂性。

#### 4. 互联网组管理协议和组播侦听发现协议

当组播数据报在广域网或是在跨越多个子网的企业中转发时，我们要求组播路由应该由一个或多个组播路由器启动。这种情况很复杂因为为了合理安排要交付的组播流量，组播路由器需要了解哪些主机对什么组播感兴趣，因此他们使用反向路径转发（RPF）检查。此过程在到达的组播数据报的原地址进行路由查找。**只有当路由的传出接口和数据报到达的接口相匹配的时候，数据报才转发**。

两个协议主要用于允许组播路由器了解附近的主机感兴趣的组：IPv4使用的互联网组管理协议（IGMP）以及IPv6使用的组播侦听发现（MLD）协议。这些协议让LAN上的组播路由器知道那些主机当前属于哪些组播组，也知道哪些组播数据应该转发到哪些接口。

下图显示了具有组播功能的路由器是如何使用IGMP。可以发现，IGMP查询是由组播路由器发送的，成员资格报告报文由组成员发送以响应查询，但是也可能从一些主机以一种主动提供的方式来发送，这些主机希望通知组播路由器它们的组成员资格和/或对特定源的兴趣已经改变了。

![组播路由器使用IGMP](/img/in-post/tcp-ip-1/5.png)

IGMP和MLD定义了两组协议处理规则，有组成员的主机执行的和由组播路由器执行的。一般来说，组成员的工作是自发报告对组播组和源的兴趣改变，以及响应定期的查询。组播路由器发送查询以确定连接链路上的对于任意组或是特定的组播组和源是否有兴趣。

##### 4.1 组成员部分

IGMP报告采取如下图所示的格式：

![IGMP报告格式](/img/in-post/tcp-ip-1/6.png)

报告报文包含了一个组记录向量，每个提供了有关特定组播组的信息，包括主题组的地址，以及建立过滤器的一个可选源列表。每一个组记录的格式如下图所示。源列表涉及了包含(include)或排除(exclude)模式。在包含模式中，在列表中的源是流量应该被接收的唯一的源。在排除模式中，在列表中的源是应该被过滤掉的（所有其他的是允许的）。离开一个组可以表示为使用没有源的包含模式过滤器，一个组的简单加入（即对所有源）可以表示为使用没有源的排除模式滤波器。

![IGMP组记录格式](/img/in-post/tcp-ip-1/7.png)

当接收到一个查询时，组成员没有立即回应。相反，它们设置一个随机的有界限的计时器来决定何时响应。在此期间，进程可能会改变它们的组/源兴趣。任何这样的变化可以在计时器到期前一起处理来触发报告。 这样一来，一旦计时器到期，多个组的状态可以更容易地被合并成一个单一的报告，**节省了开销**。

##### 4.2 组播路由器部分

在IGMP和MLD中，组播路由器的工作是为每个组播组、接口和源列表确定是否至少有一个组成员目前在接收相应的流量。这是通过发送查询，以及基于成员发送的报告，建立描述成员存在性的状态来完成的。此状态是**软状态**，这意味着，如果没有被刷新，在经过一 个确定的时间后，它会被清除。为了建立这种状态，组播路由器发送IGMPv3查询，其形式如图所示：

![IGMP查询格式](/img/in-post/tcp-ip-1/8.png)

其中，最大响应代码字段表示查询的接收方在发送报告之前应该延迟的最大时间量对于128以下的值咦100ms位单位编码，对于更大的值以如下所示指数+尾数的方式表示，能够表示约13s~53min的范围。

![最大响应代码](/img/in-post/tcp-ip-1/9.png)

使用较小的最大响应代码字段的值允许调节离开延迟（从最后一个组曾远离开的时间到相应流量不再被转发所需要的时间），增加该字段的值可以减少由成员生成的IGMP报文流量负载。

##### 4.3 轻量级IGMP和MLD

主机维护对他们的应用和系统软件感兴趣的组播组的过滤器状态，对于IGMPv3或MLDv2，他们也维护被排除或包含的源列表。为了了解什么流量需要被转发到链路上以便有兴趣的主机收到，组播路由器维护类似的状态。一个组播路由器停止转发在每个接收方的排除列表中的主机发送的组播流量。在实践经验中证明，**应用程序很少需要屏蔽特定源**，因此，简化版的IGMPv3以及MLDv2称为LW-IGMPv3和LW-MLDv2。

LW-IGMPv3和LW-MLDv2缺少特定阻塞源的功能，相反唯一支持的排除模式是没有列出源的情况，他对对应于所有版本中IGMP或MLD中的传统组的加入。对于组播路由器，唯一需要的状态时记录哪些组感兴趣哪些源感兴趣，而不需要记录任何不期望的单个源。

##### 4.4 IGMP和MLD健壮性

对于IGMP和MLD协议的健壮性和可靠性有两个主要的问题，IGMP或MLD的失效或更一般的组播，可以导致不需要的组播流量的分配，或没有能力交付期望的组播流量。由IGMP和MLD处理的失败类型包含组播路由器的失效和协议报文的丢失。

通过允许多个组播路由器在同一链路上运行可以处理组播路由器潜在的失效故障。多个组播路由器实现的第一种类型的协调是查询器选举（querier election）。**每个组播路由器可以侦听其他的查询，当一个组播路由器启动时，它认为自己是查询器并发送一般查询以确定子网中哪些组是活跃的。当一个路由器收到另一个组播路由器的组播查询时，比较源IP地址与它自己的，较小的那个认为是获胜者并成为单一的查询器，负责向子网发送查询，其他路由器为备用路由器，设计一个计时器如果在指定时间内没有看到更多的查询，他们再次成为查询器。**查询组播路由器定期发送一般查询，已确定哪些组和主机是同一个子网的主机感兴趣的。这些查询发送的频率由查询器的*查询间隔*、可配置计时器参数确定。

##### 4.5 IGMP和MLD的计数器和变量

IGMP和MLD是软状态的协议，它们也处理路由器的失效、协议报文的丢失以及与早期协议版本的互操作性。IGMP和MLD使用的所有配置参数和状态变量包括：

- 鲁棒性变量RV：为一些状态改变报告/查询安排重传次数
- 查询间隔QI：当前查询器发送的一般查询之间的时间
- 查询响应间隔QRI：等待产生报告的最大响应时间
- IGMP中d的组成员间隔GMI和MLD中的组播地址侦听间隔MALI：对于组播路由器来说，没有看到一个报告所必须经过的时间，用以宣布对于一个组或者源/组的组合没有兴趣了
- IGMP中的其他查询出现间隔和MLD中的其他查询出现超时：对于一个非查询器组播路由器来说没有看到一个一般查询所必须经过的时间，用以宣布没有活动的查询器
- 启动查询间隔：查询器刚启动时发送的一般查询之间的额时间间隔
- 启动查询数量：查询器刚启动时发送的一般查询的数量
- IGMP中的最后成员查询间隔LMQI和MLD中的最后侦听方查询间隔（LLQI）：等待相应特定查询的报告产生的最大响应时间
- IGMP中的最后成员查询数量和MLD中的最后侦听方查询数量：发送特定查询而没有接收到相应的数量，用以宣布没有感兴趣的主机
- 主动报告间隔：主机初始状态改变报告重传之间的时间
- 旧版本查询器出现超时：主机没有接收到IGMPv1或v2请求报告而恢复到IGMPv3所需要等待的时间
- 旧主机出现超时：查询器没有接收到IGMPv1或v2报告报文而恢复到IGMPv3所需要等待的时间

##### 4.6 与IGMP和MLD相关的攻击

由于IGMP和MLD是信令协议，可以控制组播流量的流动，使用这些协议的攻击主要是Dos攻击或资源使用攻击。也有攻击利用协议的实现错误来禁用主机或导致它们执行攻击者提供的代码。

一个简单的Dos攻击可以通过发送IGMP或MLD来订阅大量的高高带宽的组播组来发起，这样会引起带宽耗尽导致拒绝服务。或者攻击者使用较小的IP地址生成请求，从而当选为链路的查询器，而设置最大相应时间为非常小的主机被诱导快速发送报告，消耗大量CPU资源。

#### 5. 总结

一般来说，**广播是指向网络上的所有节点发送流量**。在TCP/IP的背景下，广播是指向网络或子网中的所有主机发送一个数据分组，通常是本地连接的网络。**组播是只向网络中的一个子集节点发送流量**。在TCP/IP中，组播是指向网络中感兴趣的主机的一个子集发送数据分组。选择子集的方法依赖于组播流量的范围和接收方的兴趣。在许多应用中，组**播比广播更好，因为组播给没有参加通信的主机带来更少的开销**。广播在IPv4中支持，但在IPv6中不支持。广播和组播可以避免通过重复使用单播连接将相同的内容发送到多个目的地。它也可以被用于发现未知的服务器。组播是比广播更复杂的一种功能，因为必须维护状态以确定哪些主机对哪些组有兴趣。

在IPv4中，有两种类型的广播地址：受限(255.255.255.255)和定向。定向广播地址基于网络前缀和它的长度，通**过创建一个初始位和网络前缀相等、低序位被置1的32位地址形成**。通常使用定向广播代替受限广播地址是更可选的。选择哪些接口用于发送传出的广播流量依赖于操作系统。一个典型的例子是使用一个主接口用于有限广播流量，使用保存在主机的转发表中的信息来选择传出定向广播和组播的接口。

IP的组播支持一种模型，借以实现对接收组播数据分组感兴趣的进程在一组特定接口上订阅一个特定组(使用IP地址)。在具有组播功能的IEEE链路层网络上(如以太网)，传输组播IPv4流量涉及结合组地址的低序23位和前缀01:00:5e来形成用于链路层组播的MAC层目的地址。传输IPv6组播流量涉及结合组地址的低序32位和16位前缀33:33来形成 MAC层目的地址。**这些映射不是唯一的**，也就是说，多个IPv4或IPv6组地址使用相同的MAC层地址。因此，主机软件执行传入流量过滤以除去不需要的组流量。

IGMP和MLD协议分别在IPv4和IPv6中用于支持组播数据分组交付。组播路由器向附近的主机发送查询报文以确定哪些主机对哪些组有兴趣，以及(对于IGMPv3和MLDv2)哪些发送者对这些组来说是感兴趣的。主机通过发送报告来响应，该报告指明了对组的兴趣。 MLD是ICMPv6协议的一部分，而IGMP是一个位于IPv4上层的独立协议(例如 ICMP)。有些交换机配备了“探听”IGMP和MLD流量的功能，用以避免沿着生成树分支发送组播IP流量，因为其中有些分支存在没有兴趣的接收主机。IGMP和MLD有一个“鲁棒性变量”，可以设置来启用网络上易于丢失的重要信息的重传。

由于IGMP和MLD都是信令协议，可以控制其他流量的流动，针对它们的攻击往往会引起额外的资源消耗，可能导致拒绝服务。其他形式攻击利用已经发现的实现漏洞，导致执行由攻击者提供的不需要的代码。由于MLD(和MLDv2)在部署方面相对较新，发现额外的漏洞是有可能的，但这些协议限制在单一链路的操作。