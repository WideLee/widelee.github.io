---
layout:     post
title:      "TCP/IP详解学习笔记（3）"
subtitle:   "名称解析和域名系统"
date:       2017-06-11
author:     "SmartYi"
header-img: "img/in-post/tcp-ip-3/head.jpg"
tags:
    - TCP/IP
    - 计算机网络
---


## TCP/IP详解学习笔记（3）—— 名称解析和域名系统

> 2017-06-11 By Mingkuan Li

#### 1. 引言

由于研究的协议使用IP地址来识别主机，对于大众来说IP地址比较难使用和记忆，因此互联网支持使用主机名称（hostname）来识别包括客户机和服务器在内的主机。为了使用例如TCP/IP等协议，主机名称通过名称解析的过程转换成IP地址。**在互联网中最普遍最重要的一种名称解析采用分布式数据库系统，即人们常说的域名系统（DNS）**。

DNS是一个**分布式**的客户机/服务器网络数据库，TCP/IP应用程序使用它来完成主机名称与IP地址之间的映射，提供**电子邮件路由信息**、**服务命名**和其他服务。DNS服务器没有一个独立的站点能够知道所有的信息，每个站点（如学院、大学、公司等）维护自己的信息数据库，并运行一个服务器程序供互联网上的其他系统查询。DNS提供了允许客户机和服务器相互通信的协议，并且也提供了服务器之间交互信息的协议。因此他是一个分布式的数据库系统。

从应用程序的角度来看，访问DNS是通过一个称为**地址解析器**的应用程序库来完成。通常，在请求TCP打开一个连接或使用UDP发送一个数据报之前，应用程序必须将主机名称转换为IP地址，TCP/IP协议实现对DNS一无所知，他们只对解析后的地址进行操作。


#### 2. DNS 名称空间

DNS中使用的所有的名称集合构成了**DNS名称空间**，命名空间和计算机文件系统类似，都是**划分层次**而且**大小写不敏感**的。当前DNS名称空间是一棵域名树，树的最高层是所谓的顶级域名（TLD），通常包括*国家顶级域名（gTLD）*、*国家代码顶级域名（ccTLD）*、*国际化国家代码顶级域名（IDN ccTLD）*，这些构成了一棵命名树的最高层，如下图所示：

![DNS命名树的顶层结构](/img/in-post/tcp-ip-3/1.png)

gTLD分类几类：**通用、通用限制和赞助**。通用gTLD是开放的可以无限制使用，例如edu用于教育机构，mil和gov用于美国的军事和政府机构。

DNS名称树中TLD下面的名称进一步划分成组，称为**子域名**。我们所看到的名称示例一般被称为完全限定域名（FQDN），他们有时候更正式书写为带有后随点的形式（如mit.edu.)。后随点表示该名称是完整的，当进行名称解析的时候，没有额外的信息添加到该域名。与之对应的位**非限定域名**，会有一个或多个字符串添加到尾部。当配置系统的时候，使用DHCP制定一个默认域名扩展和搜索列表，例如默认域名`sysu.edu.cn`在中山大学的系统里配置，如果在这些机器上输入名称`helpdesk`，本地解析器就会把这个名称转换成FQDN `helpdesk.sysu.edu.cn`。然后调用解析器确定`helpdesk`的IP地址，如下图所示：

![默认地址](/img/in-post/tcp-ip-3/2.png)

一个域名包含有点分开的标签（label），从根开始按名称中的自右向左的顺序进行。处于匹配的目的，标签是**大小写不敏感**的，每个标签最长63个字符，整个FQDN最长255个字符。

DNS名称空间的层次结构允许不同的管理机构管理名称空间的不同部分。例如`helpdesk.sysu.edu.cn`可能只需要与`sysu.edu.cn`子域的拥有者协商即可。DNS的这个特点是它**可扩展性**的一个重要方面，即没有一个单一的实体需要管理整个DNS名称空间的所有变化。

#### 3. 名称服务器和区域

部分DNS命名空间的管理责任分配给个人或组织。负责管理部分有效DNS名称空间的个人应该至少安装两台名称服务器或DNS服务器来存储名称空间的相关信息，以便互联网用户查询名称。服务器的集合形成了DNS本身，也就是一个分布式系统，其主要工作是提供名称到地址的映射。

在DNS服务器的语言中，管理授权的单位称为区域（zone）。一个区域是DNS名称空间的一棵子树，它可以独立管理而不受其他区域影响。每一个域名都存在于某个区域中，即使是TLD，它也存在于根区域（rootzone）中。每当一个新记录添加到区域中时，该区域的DNS管理员为该新条目分配一个名称和附加信息（通常是IP地址），并且将这些信息保存到名称服务器的数据库中。

一台DNS服务器可以包含多个区域信息，在一个域名的任何层次变化点上，不同区域包含的服务器可能被访问以提供该名称的信息，这称为**授权**。区域信息应该至少存在于两个地方，这意味着至少应该有两台服务器包含每个区域的信息，为了形成**冗余**，如果一台服务器不能正常工作，至少另一台服务器可以使用。

通常情况下，在服务器之间，一台主服务器（primary server）在磁盘文件中包含区域数据库，一个或多个辅助服务（secondary server）使用称为区域传输（zone transfer）的进程，从主服务器完整地获取该数据库的副本，DNS有一个专用的协议用于执行区域传输，但是区域内容的副本也可以通过其他方式获取。

#### 4. 缓存

名称服务器包含如名称到IP地址映射的信息，这些信息可以从三个途径获取：
- 直接来自区域数据库
- 区域传输的结果，从一个从属服务器中获取
- 来自于处理解析过程中的另一台服务器
第一种情况下，服务器应该包含该区域的**授权信息**，可以成为该区域的授权服务器，这样的服务器能够通过该区域信息内的名称鉴定。

大部分名称服务器会缓存他们学习的区域信息，直到TTL时间限制为止。它们使用缓存的信息来应答查询请求，这样能大大减少DNS消息的流量，不需要将这些流量在互联网上传输。每个DNS记录（名称到IP地址的映射）都有自己的TTL以控制其缓存的时间。

缓存同时也包括了否定缓存，指的是不成功的解析。如果一个特定域名的请求无法返回一个记录，该事实会被缓存，但个出错的应用一再请求不存在的域名时，这样可以降低互联网的流量。

#### 5. DNS协议

DNS协议主要由两部分组成：
- 用于执行对DNS特定名称选讯的查询/相应协议
- 名称服务器用于交换数据库记录的协议

通常来说，DNS名称解析就是讲域名映射到IPv4的过程，IPv6地址映射的方式本质上也是一样的。通过在每个站点或ISP本地部署服务器和一组特殊的**根服务器**构成DNS分布式基础设施，通过该基础设施支持DNS**查询/相应**操作。还有一套特殊的**通用顶级域名服务器**用于扩展包括com和net在内的较大的gTLD。

一个完整的解析过程如下图所示，主要通过**递归查询**的方式查询`EXAMPLE.COM`的IP地址。
![默认的DNS解析过程](/img/in-post/tcp-ip-3/3.png)

##### 5.1 DNS消息格式

有一种基本的DNS消息格式，用于所有的DNS操作中，包括**查询**、**响应**、**区域传输**、**通知**和**动态更新**。
消息格式如下图所示：
![DNS消息格式](/img/in-post/tcp-ip-3/4.png)

基本的DNS消息一固定的12字节头部开始，其后跟随4个可变长度的区段，**查询**、**回答**、**授权记录**和**额外记录**。

在固定长度的头部中，事务ID（Transaction ID）字段由客户端设置，由服务器返回。客户端使用它来匹配响应和查询。第二个16位字段包含一些标志与其他子域。

RD是1位字段，表示“期望递归”，该字段可以在一个查询中设置，并在响应中返回。他告诉服务器执行递归查询。如果该字段没有设置，且被请求的名称服务器没有授权回答，则被请求的名称服务器就返回一个可以联系获取回答的其他名称服务器的列表。此时，全部的查询可能通过联系其他名称服务器来继续。这被称为迭代查询。

RA是1位字段，表示“递归可用”，如果服务器支持递归查询，则在响应中设置该字段。**根服务器一般不支持递归查询**，因此强制客户端执行迭代查询来完成名称解析。

###### 5.1.1 名称与标签
###### 5.1.2 数据标签
###### 5.1.3 压缩标签

